#!/bin/bash

# =============================================================================
# Windowsç”¨ Pre-commit Hook - çµ±åˆé™çš„è§£æã‚·ã‚¹ãƒ†ãƒ 
# =============================================================================
# 
# Windowsç’°å¢ƒ (Git Bash) ã«æœ€é©åŒ–ã•ã‚ŒãŸpre-commitãƒ•ãƒƒã‚¯ã§ã™ã€‚
# ã‚³ãƒŸãƒƒãƒˆæ™‚ã«çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚’å®Ÿè¡Œã—ã€å“è³ªã‚²ãƒ¼ãƒˆã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
#
# é™¤å¤–ãƒ–ãƒ©ãƒ³ãƒ: main, master, develop, release/*, hotfix/*  
# å®Ÿè¡Œå†…å®¹: çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ + Checkstyle + PMD + SpotBugs
#
# æ³¨æ„: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã‚’è¡Œã£ã¦ã„ã¾ã›ã‚“ã€‚
#       Windowsç’°å¢ƒã§ã®å‹•ä½œç¢ºèªå¾Œã€å¿…è¦ã«å¿œã˜ã¦èª¿æ•´ã—ã¦ãã ã•ã„ã€‚
#
# =============================================================================

set -e

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆå–å¾—
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# é™¤å¤–ãƒ–ãƒ©ãƒ³ãƒãƒªã‚¹ãƒˆï¼ˆé™çš„è§£æã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒï¼‰
SKIP_BRANCHES=(
    "main"
    "master" 
    "master-test"
    "develop"
    "release/*"
    "hotfix/*"
)

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
log_info() {
    echo "ğŸ”§ $1"
}

log_success() {
    echo "âœ… $1"
}

log_warning() {
    echo "âš ï¸  $1"
}

log_error() {
    echo "âŒ $1"
}

log_skip() {
    echo "ğŸ”„ $1"
}

log_note() {
    echo "ğŸ“ $1"
}

# ãƒ–ãƒ©ãƒ³ãƒé™¤å¤–ãƒã‚§ãƒƒã‚¯
check_branch_exclusion() {
    for skip_branch in "${SKIP_BRANCHES[@]}"; do
        if [[ "$CURRENT_BRANCH" == $skip_branch ]]; then
            log_skip "ãƒ–ãƒ©ãƒ³ãƒ '$CURRENT_BRANCH' ã¯é™çš„è§£æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            log_success "ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™ï¼ˆå“è³ªãƒã‚§ãƒƒã‚¯ç„¡ã—ï¼‰"
            exit 0
        fi
    done
}

# Windowsç’°å¢ƒæƒ…å ±å–å¾—
get_windows_info() {
    if command -v systeminfo >/dev/null 2>&1; then
        WINDOWS_VERSION=$(systeminfo 2>/dev/null | grep "OS Name" | cut -d: -f2 | sed 's/^ *//' || echo "Windows (ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸æ˜)")
    else
        WINDOWS_VERSION="Windows (Git Bash)"
    fi
}

# çµæœãƒ­ã‚°ç”Ÿæˆ
generate_result_log() {
    local exit_code=$1
    local log_file="$PROJECT_ROOT/.git/pre-commit-last-run.log"
    local result_file="$PROJECT_ROOT/pre-commit-result.txt"
    
    # Windowsç’°å¢ƒæƒ…å ±å–å¾—
    get_windows_info
    
    # è©³ç´°ãƒ­ã‚°ç”Ÿæˆ
    {
        echo "=== Windowsç”¨ Pre-commit Hook å®Ÿè¡Œçµæœ ==="
        echo "å®Ÿè¡Œæ™‚é–“: $(date)"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $CURRENT_BRANCH"
        echo "å®Ÿè¡Œç’°å¢ƒ: $WINDOWS_VERSION"
        echo "Git Bash: $BASH_VERSION"
        echo "Javaç‰ˆ: $(java -version 2>&1 | head -n1 || echo 'Javaæƒ…å ±å–å¾—å¤±æ•—')"
        echo ""
        echo "=== å®Ÿè¡Œå†…å®¹ ==="
        echo "1. Windowsç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ"
        echo "2. scripts/core/windows/format-and-check.sh"
        echo ""
        echo "âš ï¸ æ³¨æ„: Windowsç’°å¢ƒã§ã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã¯æœªå®Œäº†ã§ã™"
        echo ""
        echo "=== å®Ÿè¡Œçµæœè©³ç´° ==="
    } > "$log_file"
    
    # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
    cat >> "$log_file"
    
    # Eclipse/IntelliJ IDEAç”¨ã®çµæœãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    cp "$log_file" "$result_file"
    
    # çµæœã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
    if [ $exit_code -eq 0 ]; then
        echo "" >> "$result_file"
        echo "âœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ" >> "$result_file"
        echo "ğŸ‰ ã‚³ãƒŸãƒƒãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ" >> "$result_file"
        echo "" >> "$result_file"
        echo "ğŸ“ Windowsç’°å¢ƒã§ã®å®Ÿè¡ŒãŒæˆåŠŸã—ã¾ã—ãŸ" >> "$result_file"
    else
        echo "" >> "$result_file"
        echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> "$result_file"
        echo "ğŸ”§ ä¿®æ­£å¾Œã€å†åº¦ã‚³ãƒŸãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" >> "$result_file"
        echo "" >> "$result_file"
        echo "ğŸ“‹ Windowsç”¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:" >> "$result_file"
        echo "  - PRE-COMMIT-GUIDE-WINDOWS.md ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> "$result_file"
        echo "  - æ‰‹å‹•å®Ÿè¡Œ: cd DroneInventorySystem && ../scripts/core/windows/format-and-check.sh" >> "$result_file"
        echo "  - ç’°å¢ƒå¤‰æ•°ç¢ºèª: echo %JAVA_HOME% && echo %PATH%" >> "$result_file"
        echo "  - Chocolateyæ›´æ–°: choco upgrade all (ç®¡ç†è€…æ¨©é™)" >> "$result_file"
        echo "  - Windows Defenderé™¤å¤–è¨­å®šã‚’æ¤œè¨ã—ã¦ãã ã•ã„" >> "$result_file"
        echo "" >> "$result_file"
        echo "âš ï¸ Windowsç’°å¢ƒã§ã®å•é¡Œã¯GitHubã®Issueã§å ±å‘Šã—ã¦ãã ã•ã„" >> "$result_file"
    fi
}

# ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
show_error_guide() {
    log_error "Pre-commit checks ã«å¤±æ•—ã—ã¾ã—ãŸ"
    echo ""
    log_info "ğŸ“‹ è©³ç´°ç¢ºèªæ–¹æ³•ï¼ˆWindowsç”¨ï¼‰:"
    echo ""
    echo "  ã€Eclipse IDEã€‘"
    echo "    Package Explorer ã§ 'pre-commit-result.txt' ã‚’é–‹ã„ã¦ãã ã•ã„"
    echo ""
    echo "  ã€IntelliJ IDEAã€‘"
    echo "    Project toolwindow ã§ 'pre-commit-result.txt' ã‚’é–‹ã„ã¦ãã ã•ã„"
    echo ""
    echo "  ã€VS Codeã€‘"  
    echo "    Explorer ã§ 'pre-commit-result.txt' ã‚’é–‹ã„ã¦ãã ã•ã„"
    echo ""
    echo "  ã€æ‰‹å‹•å®Ÿè¡Œï¼ˆGit Bashï¼‰ã€‘"
    echo "    cd DroneInventorySystem"
    echo "    ../scripts/core/windows/format-and-check.sh"
    echo ""
    echo "  ã€Windowså›ºæœ‰ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€‘"
    echo "    - ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ç’°å¢ƒå¤‰æ•°ç¢ºèª: echo %JAVA_HOME%"
    echo "    - Windows Defenderã®é™¤å¤–è¨­å®šã‚’ç¢ºèª"
    echo "    - ç®¡ç†è€…æ¨©é™ã§ã®Chocolateyæ›´æ–°: choco upgrade all"
    echo ""
    log_note "Windowsç’°å¢ƒã§ã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã¯æœªå®Œäº†ã§ã™"
    log_info "Windowsç”¨ Pre-commit Hook by development-webCourse-DroneInventorySystem"
}

# Windowså›ºæœ‰ã®ç’°å¢ƒãƒã‚§ãƒƒã‚¯
check_windows_environment() {
    # Git Bashç’°å¢ƒç¢ºèª
    if [ -n "$BASH_VERSION" ]; then
        log_success "Git Bashç’°å¢ƒ: ç¢ºèªæ¸ˆã¿"
    else
        log_warning "Git Bashç’°å¢ƒã§ã¯ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    fi
    
    # Windowsç’°å¢ƒç¢ºèª
    get_windows_info
    log_info "å®Ÿè¡Œç’°å¢ƒ: $WINDOWS_VERSION"
    
    # å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã®å­˜åœ¨ç¢ºèª
    local missing_commands=()
    
    if ! command -v java >/dev/null 2>&1; then
        missing_commands+=("java")
    fi
    
    if ! command -v mvn >/dev/null 2>&1 && ! command -v mvn.cmd >/dev/null 2>&1; then
        missing_commands+=("maven")
    fi
    
    if ! command -v node >/dev/null 2>&1; then
        missing_commands+=("node")
    fi
    
    if [ ${#missing_commands[@]} -gt 0 ]; then
        log_warning "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing_commands[*]}"
        log_note "Windowsç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å†å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™"
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    log_info "Windowsç”¨ Pre-commit Hook: çµ±åˆé™çš„è§£æã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
    log_note "æ³¨æ„: Windowsç’°å¢ƒã§ã®å®Ÿæ©Ÿãƒ†ã‚¹ãƒˆã¯æœªå®Œäº†ã§ã™"
    echo "ğŸ“ ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $CURRENT_BRANCH"
    echo "ğŸ¨ çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: Spaceâ†’Tab + Prettier Java + Eclipse Formatter"
    echo "ğŸ” é™çš„è§£æ: Checkstyle + PMD + SpotBugs (JDK 17å¯¾å¿œ)"
    echo "âš ï¸  æ³¨æ„: å“è³ªé•åãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€ã‚³ãƒŸãƒƒãƒˆã¯é˜»æ­¢ã•ã‚Œã¾ã™"
    echo ""
    
    # Windowsç’°å¢ƒãƒã‚§ãƒƒã‚¯
    check_windows_environment
    
    # ãƒ–ãƒ©ãƒ³ãƒé™¤å¤–ãƒã‚§ãƒƒã‚¯
    check_branch_exclusion
    
    # DroneInventorySystemãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
    if [ ! -d "$PROJECT_ROOT/DroneInventorySystem" ]; then
        log_error "DroneInventorySystemãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi
    
    cd "$PROJECT_ROOT/DroneInventorySystem"
    
    # Windowsç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    log_info "Windowsç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æå®Ÿè¡Œä¸­..."
    
    if [ -f "../scripts/core/windows/format-and-check.sh" ]; then
        # å®Ÿè¡Œæ¨©é™ç¢ºèª
        chmod +x "../scripts/core/windows/format-and-check.sh"
        
        # å®Ÿè¡Œçµæœã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        if ../scripts/core/windows/format-and-check.sh 2>&1 | generate_result_log 0; then
            log_success "Windowsç”¨çµ±åˆé™çš„è§£æ: å…¨ã¦åˆæ ¼"
            log_success "ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™"
            log_note "Windowsç’°å¢ƒã§ã®å®Ÿè¡ŒãŒæˆåŠŸã—ã¾ã—ãŸ"
            exit 0
        else
            # ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
            ../scripts/core/windows/format-and-check.sh 2>&1 | generate_result_log 1
            show_error_guide
            exit 1
        fi
    else
        log_error "Windowsç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        log_error "æœŸå¾…ã•ã‚Œã‚‹å ´æ‰€: scripts/core/windows/format-and-check.sh"
        log_note "Windowsç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
        exit 1
    fi
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
