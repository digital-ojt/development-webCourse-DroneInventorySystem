#!/bin/bash

# =============================================================================
# macOSç”¨ Pre-commit Hook - çµ±åˆé™çš„è§£æã‚·ã‚¹ãƒ†ãƒ 
# =============================================================================
# 
# macOSç’°å¢ƒã«æœ€é©åŒ–ã•ã‚ŒãŸpre-commitãƒ•ãƒƒã‚¯ã§ã™ã€‚
# ã‚³ãƒŸãƒƒãƒˆæ™‚ã«çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚’å®Ÿè¡Œã—ã€å“è³ªã‚²ãƒ¼ãƒˆã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚
#
# é™¤å¤–ãƒ–ãƒ©ãƒ³ãƒ: main, master, develop, release/*, hotfix/*  
# å®Ÿè¡Œå†…å®¹: çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ + Checkstyle + PMD + SpotBugs
#
# =============================================================================

set -e

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆå–å¾—
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# é™¤å¤–ãƒ–ãƒ©ãƒ³ãƒãƒªã‚¹ãƒˆï¼ˆé™çš„è§£æã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒï¼‰
SKIP_BRANCHES=(
    "main"
    "master" 
    "master-test"
    "develop"
    "release/*"
    "hotfix/*"
)

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’å–å¾—
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
log_info() {
    echo "ğŸ”§ $1"
}

log_success() {
    echo "âœ… $1"
}

log_warning() {
    echo "âš ï¸  $1"
}

log_error() {
    echo "âŒ $1"
}

log_skip() {
    echo "ğŸ”„ $1"
}

# ãƒ–ãƒ©ãƒ³ãƒé™¤å¤–ãƒã‚§ãƒƒã‚¯
check_branch_exclusion() {
    for skip_branch in "${SKIP_BRANCHES[@]}"; do
        if [[ "$CURRENT_BRANCH" == $skip_branch ]]; then
            log_skip "ãƒ–ãƒ©ãƒ³ãƒ '$CURRENT_BRANCH' ã¯é™çš„è§£æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            log_success "ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™ï¼ˆå“è³ªãƒã‚§ãƒƒã‚¯ç„¡ã—ï¼‰"
            exit 0
        fi
    done
}

# çµæœãƒ­ã‚°ç”Ÿæˆ
generate_result_log() {
    local exit_code=$1
    local log_file="$PROJECT_ROOT/.git/pre-commit-last-run.log"
    local result_file="$PROJECT_ROOT/pre-commit-result.txt"
    
    # è©³ç´°ãƒ­ã‚°ç”Ÿæˆ
    {
        echo "=== macOSç”¨ Pre-commit Hook å®Ÿè¡Œçµæœ ==="
        echo "å®Ÿè¡Œæ™‚é–“: $(date)"
        echo "ãƒ–ãƒ©ãƒ³ãƒ: $CURRENT_BRANCH"
        echo "å®Ÿè¡Œç’°å¢ƒ: macOS $(sw_vers -productVersion)"
        echo "Javaç‰ˆ: $(java -version 2>&1 | head -n1)"
        echo ""
        echo "=== å®Ÿè¡Œå†…å®¹ ==="
        echo "1. macOSç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ"
        echo "2. scripts/core/mac/format-and-check.sh"
        echo ""
        echo "=== å®Ÿè¡Œçµæœè©³ç´° ==="
    } > "$log_file"
    
    # çµæœã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½è¨˜
    cat >> "$log_file"
    
    # Eclipse/IntelliJ IDEAç”¨ã®çµæœãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
    cp "$log_file" "$result_file"
    
    # çµæœã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
    if [ $exit_code -eq 0 ]; then
        echo "" >> "$result_file"
        echo "âœ… å…¨ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ" >> "$result_file"
        echo "ğŸ‰ ã‚³ãƒŸãƒƒãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ" >> "$result_file"
    else
        echo "" >> "$result_file"
        echo "âŒ å“è³ªãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> "$result_file"
        echo "ğŸ”§ ä¿®æ­£å¾Œã€å†åº¦ã‚³ãƒŸãƒƒãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„" >> "$result_file"
        echo "" >> "$result_file"
        echo "ğŸ“‹ macOSç”¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:" >> "$result_file"
        echo "  - PRE-COMMIT-GUIDE-MAC.md ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> "$result_file"
        echo "  - æ‰‹å‹•å®Ÿè¡Œ: cd DroneInventorySystem && ../scripts/core/mac/format-and-check.sh" >> "$result_file"
        echo "  - Homebrewæ›´æ–°: brew update && brew upgrade" >> "$result_file"
    fi
}

# ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
show_error_guide() {
    log_error "Pre-commit checks ã«å¤±æ•—ã—ã¾ã—ãŸ"
    echo ""
    log_info "ğŸ“‹ è©³ç´°ç¢ºèªæ–¹æ³•ï¼ˆmacOSç”¨ï¼‰:"
    echo ""
    echo "  ã€Eclipse IDEã€‘"
    echo "    Package Explorer ã§ 'pre-commit-result.txt' ã‚’é–‹ã„ã¦ãã ã•ã„"
    echo ""
    echo "  ã€IntelliJ IDEAã€‘"
    echo "    Project toolwindow ã§ 'pre-commit-result.txt' ã‚’é–‹ã„ã¦ãã ã•ã„"
    echo ""
    echo "  ã€VS Codeã€‘"  
    echo "    Explorer ã§ 'pre-commit-result.txt' ã‚’é–‹ã„ã¦ãã ã•ã„"
    echo ""
    echo "  ã€æ‰‹å‹•å®Ÿè¡Œï¼ˆã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰ã€‘"
    echo "    cd DroneInventorySystem"
    echo "    ../scripts/core/mac/format-and-check.sh"
    echo ""
    log_info "macOSç”¨ Pre-commit Hook by development-webCourse-DroneInventorySystem"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    log_info "macOSç”¨ Pre-commit Hook: çµ±åˆé™çš„è§£æã‚·ã‚¹ãƒ†ãƒ é–‹å§‹"
    echo "ğŸ“ ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: $CURRENT_BRANCH"
    echo "ğŸ¨ çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: Spaceâ†’Tab + Prettier Java + Eclipse Formatter"
    echo "ğŸ” é™çš„è§£æ: Checkstyle + PMD + SpotBugs (JDK 17å¯¾å¿œ)"
    echo "âš ï¸  æ³¨æ„: å“è³ªé•åãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€ã‚³ãƒŸãƒƒãƒˆã¯é˜»æ­¢ã•ã‚Œã¾ã™"
    echo ""
    
    # ãƒ–ãƒ©ãƒ³ãƒé™¤å¤–ãƒã‚§ãƒƒã‚¯
    check_branch_exclusion
    
    # DroneInventorySystemãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
    if [ ! -d "$PROJECT_ROOT/DroneInventorySystem" ]; then
        log_error "DroneInventorySystemãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        exit 1
    fi
    
    cd "$PROJECT_ROOT/DroneInventorySystem"
    
    # macOSç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
    log_info "macOSç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æå®Ÿè¡Œä¸­..."
    
    if [ -f "../scripts/core/mac/format-and-check.sh" ]; then
        # å®Ÿè¡Œæ¨©é™ç¢ºèª
        chmod +x "../scripts/core/mac/format-and-check.sh"
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿè¡Œçµæœã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        local temp_output="$PROJECT_ROOT/.git/pre-commit-temp-output.log"
        
        # é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€exit codeã‚’ä¿æŒ
        ../scripts/core/mac/format-and-check.sh > "$temp_output" 2>&1
        local exit_code=$?
        
        # çµæœãƒ­ã‚°ã‚’ç”Ÿæˆ
        cat "$temp_output" | generate_result_log $exit_code
        
        # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
        rm -f "$temp_output"
        
        # exit codeã«å¿œã˜ã¦ã‚³ãƒŸãƒƒãƒˆåˆ¶å¾¡
        if [ $exit_code -eq 0 ]; then
            log_success "macOSç”¨çµ±åˆé™çš„è§£æ: å…¨ã¦åˆæ ¼"
            log_success "ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™"
            exit 0
        else
            log_error "macOSç”¨çµ±åˆé™çš„è§£æ: å“è³ªé•åãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            show_error_guide
            exit 1
        fi
    else
        log_error "macOSç”¨çµ±åˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ»é™çš„è§£æã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        log_error "æœŸå¾…ã•ã‚Œã‚‹å ´æ‰€: scripts/core/mac/format-and-check.sh"
        exit 1
    fi
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"
